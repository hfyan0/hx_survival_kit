#!/bin/bash

work_plan=$HOME/sunny/work_plan.txt
work_plan_old=$HOME/sunny/work_plan_old.txt
note_txt=$HOME/sunny/note.txt

work_plan2=$HOME/sunny/.work_plan.txt
work_plan_old2=$HOME/sunny/.work_plan_old.txt
note_txt2=$HOME/sunny/.note.txt

work_plan_ostdg=$HOME/sunny/work_plan_ostdg.txt
note_old_txt=$HOME/sunny/note_old.txt

chmod 644 $work_plan_ostdg

proc_cnt=$(ps aux | grep -e $(basename $work_plan) -e $(basename $work_plan_old) -e $(basename $work_plan_ostdg) -e $(basename $note_txt) -e $(basename $note_old_txt) | grep -v grep | wc -l)

if [[ $proc_cnt -gt 0 ]]
then
    echo "Already running."
    exit
fi

cat $note_txt      | sde > $note_txt2
cat $work_plan     | sde > $work_plan2
cat $work_plan_old | sde > $work_plan_old2

# create summary
cat $work_plan2 \
  | grep -e 'TODO' -e '- \[ \]' -e '==========' -e '----------' \
  | sed 's/----------/====================/g' \
  | sed 's/^\s\+$//' \
  | sed '/^$/d' \
  | uniq \
  | sed '/==========/{x;p;x;}' \
  > $work_plan_ostdg

chmod 444 $work_plan_ostdg

#
nvim -u ~/.advenv/dotfiles/org_vimrc -p $work_plan2 $note_txt2 $work_plan_ostdg $work_plan_old2 $note_old_txt

cat $note_txt2      | sen > $note_txt
cat $work_plan2     | sen > $work_plan
cat $work_plan_old2 | sen > $work_plan_old

rm -f $note_txt2 $work_plan2 $work_plan_old2
